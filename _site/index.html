<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Upstream</title><link href="https://fonts.googleapis.com/css?family=Lato:900|Work+Sans" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><title>Upstream</title><meta property="og:title" content="Upstream" /><link rel="canonical" href="https://testupstream.com/" /><meta property="og:url" content="https://testupstream.com/" /><meta property="og:site_name" content="Upstream" /><script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "Upstream", "headline": "Upstream", "url": "https://testupstream.com/"}</script></head><body style="background-color: rgb(255, 255, 255)"><script src="/js/theme.min.js"></script><header> <a href="/"><div class="home"></div></a></header><h1 class="headline">Upstream</h1><h3><article><header><a href="/2017/02/13/testing-dropwizard-ui-apps-in-memory.html">Testing Dropwizard UI Apps in Memory</a></h3></header><div><p>If you’re in <a href="https://darrenhobbs.com/2006/04/22/a-bad-citizen-in-javaland/">javaland</a>, you can do a lot worse than <a href="http://www.dropwizard.io/1.0.6/docs/">Dropwizard</a>.</p><p>A simple, lightweight web service framework built on top of Jersey with an all-star cast of mature java libraries in supporting roles.</p><p><strong>In-process testing</strong> is <em>the</em> essential technique for fast feedback when writing software. It involves having a test process (e.g. Junit) start your application and hosting it in-memory, firing requests at the app directly from an in-memory test client.</p><p>No packaging of the application. No deployment. No network IO for requests. Direct access to the application to mock external dependencies. Mock behaviour defined in code, sitting with your tests.</p><p>You can have a comprehensive, large-scale test suite run in <em>seconds</em>, which when multiplying that by the team size and number of pushes a day, is a backbone of time-saving techniques that power high-performing teams.</p><p>Dropwizard already has out-of-the-box support for in-process testing, but:</p><ul><li>testing UIs and user journeys is hard (sequential actions, form posts, persistent cookies, dealing with html, does the javascript work etc)</li><li>no support for dependency switching</li></ul><p>Here’s a tutorial for how to set up a DI-switchable integration test harness with Dropwizard and Guice, and as an added bonus, how to set that up for UI apps so you can use webdriver in-memory too.</p><p>Set-up:</p><figure class="highlight"><pre><code class="language-groovy" data-lang="groovy">	
	<span class="n">compile</span> <span class="s2">"com.hubspot.dropwizard:dropwizard-guice:1.0.0.3"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-core:1.0.6"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-views:1.0.6"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-views-freemarker:1.0.6"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-client:1.0.6"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-assets:1.0.6"</span><span class="o">,</span>
            <span class="s2">"io.dropwizard:dropwizard-metrics-graphite:1.0.6"</span><span class="o">,</span>
            <span class="s2">"com.palominolabs.metrics:metrics-guice:3.1.3"</span>
			
    <span class="n">testCompile</span> <span class="s2">"junit:junit-dep:4.11"</span><span class="o">,</span>
                <span class="s2">"org.mockito:mockito-core:1.9.5"</span><span class="o">,</span>
                <span class="s2">"io.dropwizard:dropwizard-testing:1.0.6"</span><span class="o">,</span>
                <span class="s2">"com.thoughtworks.inproctester:jerseytester-webdriver:1.1.0"</span><span class="o">,</span>
                <span class="s2">"com.thoughtworks.inproctester:jerseytester-htmlunit:1.1.0"</span>
	</code></pre></figure><ol><li>In your test code, override your guice bindings in the areas that you want to mock (e.g. time, external dependencies). Use your production guice module as the base (e.g. AppModule)</li></ol><figure class="highlight"><pre><code class="language-java" data-lang="java">	
    <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="n">Stage</span><span class="o">.</span><span class="na">PRODUCTION</span><span class="o">,</span> <span class="n">Modules</span><span class="o">.</span><span class="na">override</span><span class="o">(</span><span class="k">new</span> <span class="n">AppModule</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="n">binder</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">ResponseProvider</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">mock</span><span class="o">(</span><span class="n">ResponseProvider</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">DateTimeProvider</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">TestDateTime</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}));</span>
    </code></pre></figure><ol start="2"><li>Expose a list of resources in your DW appication class, and use ResourceTestRule instead of DropwizardAppRule. Add resource classes from the injector (my app is called App here)</li></ol><figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="n">ResourceTestRule</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceTestRule</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
    
    <span class="k">for</span> <span class="o">(</span><span class="n">Class</span> <span class="n">resource</span> <span class="o">:</span> <span class="k">new</span> <span class="n">App</span><span class="o">().</span><span class="na">getResources</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">addResource</span><span class="o">(</span><span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="n">JerseyGuiceUtils</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span> <span class="c1">//Because of https://github.com/HubSpot/dropwizard-guice/issues/95</span>
    
    <span class="n">ResourceTestRule</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    </code></pre></figure><ol start="3"><li>Use a Junit ClassRule in your test class (or superclass) to point to your built rule (i happened to wrap that up in a harness)</li></ol><figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="nd">@ClassRule</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ResourceTestRule</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">HARNESS</span><span class="o">.</span><span class="na">getRule</span><span class="o">();</span>
    </code></pre></figure><p>Enter <a href="https://github.com/aharin/jerseytester">jerseytester</a></p><p>This library provides a webdriver interface on top of a Jersey client, adapting requests and responses so you get all the good stuff from HTMLUnitDriver - persistent browser state, cookies, and the page being traversable by that sweet API.</p><ol start="4"><li>ResourceTestRule exposes a client, use this to bootstrap the webdriver</li></ol><figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JerseyClientHtmlunitDriver</span><span class="o">(</span><span class="n">rule</span><span class="o">.</span><span class="na">client</span><span class="o">());</span>
    </code></pre></figure><ul><li>Note: calling client() before the test run begins will throw an NPE*</li></ul><ol start="5"><li><p>Profit!</p><p>Here is an example of using mockito at runtime to manipulate the response of the mock. <em>(Baseuri for ResourceTestRule is “http://localhost:9998”)</em></p></li></ol><figure class="highlight"><pre><code class="language-java" data-lang="java">	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">theHomepageIsVisited</span><span class="o">()</span> <span class="o">{</span>
	    <span class="n">driver</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">baseUri</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">homepageText</span><span class="o">()</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">tagName</span><span class="o">(</span><span class="s">"body"</span><span class="o">)).</span><span class="na">getText</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">theHomePageResponseIs</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">when</span><span class="o">(</span><span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ResponseProvider</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">get</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
	
	<span class="o">}</span>
	</code></pre></figure><p>For context, the production code that uses the ResponseProvider is:</p><figure class="highlight"><pre><code class="language-java" data-lang="java">	<span class="nd">@Path</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
	<span class="nd">@Produces</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldResource</span> <span class="o">{</span>

	    <span class="kd">private</span> <span class="n">ResponseProvider</span> <span class="n">responseProvider</span><span class="o">;</span>

	    <span class="nd">@Inject</span>
	    <span class="kd">public</span> <span class="nf">HelloWorldResource</span><span class="o">(</span><span class="n">ResponseProvider</span> <span class="n">responseProvider</span><span class="o">)</span> <span class="o">{</span>
	        <span class="k">this</span><span class="o">.</span><span class="na">responseProvider</span> <span class="o">=</span> <span class="n">responseProvider</span><span class="o">;</span>
	    <span class="o">}</span>

	    <span class="nd">@GET</span>
	    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getHelloWorld</span><span class="o">(){</span>
	        <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">responseProvider</span><span class="o">.</span><span class="na">get</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
	    <span class="o">}</span>

	<span class="o">}</span>
	<span class="o">}</span>
	</code></pre></figure> <figure class="highlight"><pre><code class="language-java" data-lang="java">	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">validateInProcessMocking</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">given</span><span class="o">.</span><span class="na">theHomePageResponseIs</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
	    <span class="n">when</span><span class="o">.</span><span class="na">theHomepageIsVisited</span><span class="o">();</span>
	    <span class="n">assertThat</span><span class="o">(</span><span class="n">then</span><span class="o">.</span><span class="na">homepageText</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="n">message</span><span class="o">));</span>
	<span class="o">}</span>
	</code></pre></figure><h4 id="next-time">Next time….</h4><p>I’ll post about how to get webdriver working with your javascript</p></div></article><div id="disqus_thread"></div><script defer> (function() { var d = document, s = d.createElement('script'); s.src = '//testupstream.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><h3><article><header><a href="/2017/02/10/starting-new.html">Starting New</a></h3></header><div><p>Hey! I’ve decided to give the blog a facelift.</p><p>I might bring posts from the old site over, I don’t know - it’s still good to laugh at what i was wrong about.</p><p>More soon.</p></div></article><div id="disqus_thread"></div><script defer> (function() { var d = document, s = d.createElement('script'); s.src = '//testupstream.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><footer><div class="links"> <a href="/about/">About</a> <a href="/contact/">Contact</a></div><div class="theme" onclick="theme()" style=" background-image: url(/images/theme.svg)"></div></footer><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-91997611-1', 'auto'); ga('send', 'pageview');</script></body></html>
